<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Чат: {{ .Chat.Name }}</title>
		<style>
			/* Ваши стили */
		</style>
	</head>
	<body>
		<h1>Чат: {{ .Chat.Name }}</h1>

		<div>
			<h2>Участники чата:</h2>
			<ul>
				{{ range .Participants }}
				<li>
					{{ .Surname }} {{ .Name }} {{ .Patronymic }} - {{ if eq .Status "online" }}
					<span>Онлайн</span>
					{{ else }}
					<span>Последний раз в сети: {{ .LastActive.Format "02.01.2006 15:04" }}</span>
					{{ end }}
				</li>
				{{ end }}
			</ul>
		</div>

		<div id="messages">
			{{ range .Messages }}
			<div class="message" data-id="{{ .ID }}">
				<strong>{{ .Username }}:</strong> {{ .Content }} 
				{{ if .File.Name }}<a href="/files/{{ .ID }}">{{ .File.Name }}</a>{{ end }}
				{{ if eq .UserID $.CurrentUserID }}
				<!-- Проверка на авторство -->
				<button class="edit" onclick="editMessage({{ .ID }}, '{{ .Content | js }}')">Редактировать</button>
				<button class="delete" onclick="deleteMessage({{ .ID }})">Удалить</button>
				{{ end }}
			</div>
			{{ end }}
		</div>

		<input type="text" id="message" placeholder="Введите сообщение..." autocomplete="off" />
		<input type="file" id="file" placeholder="Загрузите файл">
		<button id="send">Отправить</button>
		<form action="/chats" method="get">
			<button type="submit">← Назад к чатам</button>
		</form>

		<script>
			        const chatID = {{ .Chat.ID }};
			        const ws = new WebSocket(`ws://${window.location.host}/ws/chat/${chatID}`);

                    ws.onmessage = function(event) {
	const msg = JSON.parse(event.data);
	if (msg.UserID !== {{ .CurrentUserID }}) {
		Notification.requestPermission().then(function (permission) {
			const title = msg.Username
			const body = msg.Content
			const icon = 'https://cdn4.iconfinder.com/data/icons/glyphs/24/icons_notifications-1024.png';
			const notification = new Notification(title, { body, icon });
			let showNotification = document.visibilityState !== "visible";
			notification.onclick = () => {
			notification.close();
			window.parent.focus();
			}
		});	
	}
    
    const messagesDiv = document.getElementById('messages');

    if (msg.action === "delete") {
        // Удаляем сообщение
        const messageDiv = document.querySelector(`.message[data-id='${msg.id}']`);
        if (messageDiv) {
            messageDiv.remove();
        }
    } else if (msg.action === "edit") {
        // Обновляем сообщение
        const messageDiv = document.querySelector(`.message[data-id='${msg.id}']`);
        if (messageDiv) {
            messageDiv.innerHTML = `<strong>${msg.Username}:</strong> ${msg.content} ${msg.UserID === {{ .CurrentUserID }} ? `<button class="edit" onclick="editMessage(${msg.id}, '${msg.content}')">Редактировать</button> <button class="delete" onclick="deleteMessage(${msg.id})">Удалить</button>` : ''}`;
        }
    } else {
        // Обработка обычного сообщения
        const isCurrentUser = msg.UserID === {{ .CurrentUserID }}; // Проверяем, является ли сообщение от текущего пользователя
        const buttons = isCurrentUser ? `<button class="edit" onclick="editMessage(${msg.ID}, '${msg.Content}')">Редактировать</button> <button class="delete" onclick="deleteMessage(${msg.ID})">Удалить</button>` : '';
        messagesDiv.innerHTML += `<div class="message" data-id="${msg.ID}"><strong>${msg.Username}:</strong> ${msg.Content} ${buttons}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight; 
        console.log("AAAA", msg.ID);// Прокрутка вниз
    }
};



			function editMessage(messageID, currentContent) {
                console.log(messageID);
    const newContent = prompt("Редактировать сообщение:", currentContent);
    if (newContent !== null) {
        fetch('/edit-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `message_id=${messageID}&content=${encodeURIComponent(newContent)}&chat_id=${chatID}`
        }).then(response => {
            if (response.ok) {
                const messageDiv = document.querySelector(`.message[data-id='${messageID}']`);
                const username = messageDiv.querySelector('strong').innerText.replace(/:$/, '');
                messageDiv.innerHTML = `<strong>${username}:</strong> ${newContent} <button class="edit" onclick="editMessage(${messageID}, '${newContent}')">Редактировать</button> <button class="delete" onclick="deleteMessage(${messageID})">Удалить</button>`;
            } else {
                alert("Ошибка редактирования сообщения");
            }
        });
    }
}



			function deleteMessage(messageID) {
			    console.log("Удаление сообщения, ID:", messageID); // ← добавили сюда
			    if (confirm("Вы уверены, что хотите удалить это сообщение?")) {
			        fetch('/delete-message', {
			            method: 'POST',
			            headers: {
			                'Content-Type': 'application/x-www-form-urlencoded',
			            },
			            body: `message_id=${messageID}&chat_id=${chatID}`
			        }).then(response => {
			            if (response.ok) {
			                const messageDiv = document.querySelector(`.message[data-id='${messageID}']`);
			                if (messageDiv) {
			                    messageDiv.remove();
			                }
			            } else {
			                alert("Ошибка удаления сообщения");
			            }
			        });
			    }
			}






					var uploadFile = {};

			        document.getElementById('send').onclick = function() {
			            const messageInput = document.getElementById('message');
						const fileInput = document.getElementById('file');
			            const message = messageInput.value;
						ws.send(JSON.stringify({ Content: message, File: uploadFile }));
						messageInput.value = ''; // Очистка поля ввода
						fileInput.value = null;
			        };

					document.getElementById('file').addEventListener('change', (event) => {
						const file = event.target.files[0];
						uploadFile.name = file.name;
						if (file) {
							const reader = new FileReader();
							reader.onload = (e) => {
								uploadFile.data = e.target.result;
							};
							reader.onerror = (e) => {
								console.error("Error reading file:", e);
							};
							reader.readAsDataURL(file);
						}
					});

			        // Отправка сообщения по нажатию клавиши Enter
			        document.getElementById('message').addEventListener('keypress', function(event) {
			            if (event.key === 'Enter') {
			                document.getElementById('send').click();
			            }
			        });
		</script>
	</body>
</html>
